---
cover: >-
  https://images.unsplash.com/photo-1550921464-9f7a27f99edc?crop=entropy&cs=srgb&fm=jpg&ixid=MnwxOTcwMjR8MHwxfHNlYXJjaHw4fHxzd2l0Y2h8ZW58MHx8fHwxNjQ4MTA3OTU1&ixlib=rb-1.2.1&q=85
coverY: 0
---

# ğŸ›¼ ç¬¬ä¸€ç«  äº¤æ¢æœº Switching Hub

## æ˜ç¡®é—®é¢˜

![img](https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2FNP7xx3RQhhjazkAY6UMO%2Fuploads%2F1cso67ZmTGtURwMsvgHw%2Fimage.png?alt=media\&token=05238729-2ca8-47e1-abb7-bdef47e75901)

å¯è§ï¼Œäº¤æ¢æœºçš„ç›®çš„æ˜¯äº¤æ¢æŠ¥æ–‡ï¼Œè€Œå·¥ä½œçš„æ–¹å¼å¦‚ä¸‹ï¼š

* æ”¶åˆ°æŸç½‘æ®µï¼ˆè®¾ä¸ºAï¼‰MACåœ°å€ä¸ºXçš„è®¡ç®—æœºå‘ç»™MACåœ°å€ä¸ºYçš„è®¡ç®—æœºçš„æ•°æ®åŒ…ã€‚äº¤æ¢æœºä»è€Œè®°ä¸‹äº†MACåœ°å€Xåœ¨ç½‘æ®µAã€‚è¿™ç§°ä¸ºå­¦ä¹ ï¼ˆlearningï¼‰ã€‚
* äº¤æ¢æœºè¿˜ä¸çŸ¥é“MACåœ°å€Yåœ¨å“ªä¸ªç½‘æ®µä¸Šï¼Œäºæ˜¯å‘é™¤äº†Aä»¥å¤–çš„æ‰€æœ‰ç½‘æ®µè½¬å‘è¯¥æ•°æ®åŒ…ã€‚è¿™ç§°ä¸ºæ³›æ´ªï¼ˆfloodingï¼‰ã€‚
* MACåœ°å€Yçš„è®¡ç®—æœºæ”¶åˆ°è¯¥æ•°æ®åŒ…ï¼Œå‘MACåœ°å€Xå‘å‡ºç¡®è®¤åŒ…ã€‚äº¤æ¢æœºæ”¶åˆ°è¯¥åŒ…åï¼Œä»è€Œè®°å½•ä¸‹MACåœ°å€Yæ‰€åœ¨çš„ç½‘æ®µã€‚
* äº¤æ¢æœºå‘MACåœ°å€Xè½¬å‘ç¡®è®¤åŒ…ã€‚è¿™ç§°ä¸ºè½¬å‘ï¼ˆforwardingï¼‰ã€‚
* äº¤æ¢æœºæ”¶åˆ°ä¸€ä¸ªæ•°æ®åŒ…ï¼ŒæŸ¥è¡¨åå‘ç°è¯¥æ•°æ®åŒ…çš„æ¥æºåœ°å€ä¸ç›®çš„åœ°å€å±äºåŒä¸€ç½‘æ®µã€‚äº¤æ¢æœºå°†ä¸å¤„ç†è¯¥æ•°æ®åŒ…ã€‚è¿™ç§°ä¸ºè¿‡æ»¤ï¼ˆfilteringï¼‰ã€‚
* äº¤æ¢æœºå†…éƒ¨çš„MACåœ°å€-ç½‘æ®µæŸ¥è¯¢è¡¨çš„æ¯æ¡è®°å½•é‡‡ç”¨æ—¶é—´æˆ³è®°å½•æœ€åä¸€æ¬¡è®¿é—®çš„æ—¶é—´ã€‚æ—©äºæŸä¸ªé˜ˆå€¼ï¼ˆç”¨æˆ·å¯é…ç½®ï¼‰çš„è®°å½•è¢«æ¸…é™¤ã€‚è¿™ç§°ä¸ºè€åŒ–ï¼ˆagingï¼‰ã€‚

## è®¾è®¡è§£å†³æ–¹æ¡ˆ

è¿™é‡Œæˆ‘ä»¬è®¡åˆ’è®¾è®¡ä¸€ä¸ªç®€å•çš„äº¤æ¢æœºï¼Œæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š

* å°æ–¼æ¥æ”¶åˆ°çš„å°åŒ…é€²è¡Œä¿®æ”¹æˆ–é‡å°æŒ‡å®šçš„é€£æ¥åŸ é€²è¡Œè½‰é€ã€‚
* å°æ–¼æ¥æ”¶åˆ°çš„å°åŒ…é€²è¡Œè½‰é€åˆ° Controller çš„å‹•ä½œï¼ˆ Packet-In ï¼‰ã€‚
* å°æ–¼æ¥æ”¶åˆ°ä¾†è‡ª Controller çš„å°åŒ…è½‰é€åˆ°æŒ‡å®šçš„é€£æ¥åŸ ï¼ˆ Packet-Out ï¼‰ã€‚ é¦–å…ˆï¼Œåˆ©ç”¨ Packet-In çš„åŠŸèƒ½ä¾†é”åˆ° MAC ä½å€çš„å­¸ç¿’ã€‚ Controller ä½¿ç”¨ Packet-In æ¥æ”¶ä¾†è‡ªäº¤æ›å™¨çš„å°åŒ…ä¹‹å¾Œé€²è¡Œåˆ†æï¼Œå¾—åˆ°é€£æ¥åŸ ç›¸é—œè³‡æ–™ä»¥åŠæ‰€é€£æ¥çš„ host ä¹‹ MAC ä½å€ã€‚ åœ¨å­¸ç¿’ä¹‹å¾Œï¼Œå°æ‰€æ”¶åˆ°çš„å°åŒ…é€²è¡Œè½‰é€ã€‚å°‡å°åŒ…çš„ç›®çš„ä½å€ï¼Œåœ¨å·²ç¶“å­¸ç¿’çš„ host è³‡æ–™ä¸­é€²è¡Œæª¢ç´¢ï¼Œæ ¹æ“šæª¢ç´¢çš„çµæœæœƒé€²è¡Œä¸‹åˆ—è™•ç†ã€‚
* å¦‚æœæ˜¯å·²ç¶“å­˜åœ¨è¨˜éŒ„ä¸­çš„ hostï¼šä½¿ç”¨ Packet-Out åŠŸèƒ½è½‰é€è‡³å…ˆå‰æ‰€å°æ‡‰çš„é€£æ¥åŸ 
* å¦‚æœæ˜¯å°šæœªå­˜åœ¨è¨˜éŒ„ä¸­çš„ hostï¼šä½¿ç”¨ Packet-Out åŠŸèƒ½ä¾†é”åˆ° Flooding

## ç¡®å®šæŠ€æœ¯æ–¹æ¡ˆ

ä½¿ç”¨ryu+mininet-wifiå¼€å‘

## å®ç°æ§åˆ¶å™¨

### äº¤æ¢æœºç±»çš„å®šä¹‰åŠåˆå§‹åŒ–

```python
class SimpleSwitch13(app_manager.RyuApp):	# ç¹¼æ‰¿äº† ryu.base.app_manager.RyuApp
# ç±»ä¼¼handshakeè¿™ç±»å®šç¾©å¥½è®“ OpenFlow äº¤æ›å™¨å’Œ Controller ä¹‹é–“é€²è¡Œé€šè¨Šæ™‚ä½¿ç”¨çš„å‡½æ•°RYUå¾ˆå…¨
    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]	# ä½¿ç”¨ OpenFlow 1.3

    def __init__(self, *args, **kwargs):
        super(SimpleSwitch13, self).__init__(*args, **kwargs)
        self.mac_to_port = {}	# å®šä¹‰ MAC ä½å€è¡¨çš„ mac_to_port
```

### äº‹ä»¶ç®¡ç† Event handler

```python
"""
       æ¥å—åˆ°ä»»ä½•ä¸€å€‹ OpenFlow è¨Šæ¯å³æœƒç”¢ç”Ÿä¸€å€‹ç›¸å°æ‡‰çš„äº‹ä»¶
       äº‹ä»¶ç®¡ç†ï¼ˆ Event Handler ï¼‰ä½¿ç”¨ä¿®é£¾å™¨ï¼ˆ Decorator ï¼‰æ ‡è®°
       set_ev_cls å‰‡æŒ‡å®šäº‹ä»¶é¡åˆ¥å¾—ä»¥æ¥å—è¨Šæ¯å’Œäº¤æ›å™¨ç‹€æ…‹ä½œç‚ºåƒæ•¸ã€‚
       åç¨±çš„è¦å‰‡ç‚º ryu.controller.ofp_event.EventOFP + <OpenFlowè¨Šæ¯åç¨±>

       =========================================== ===============================
       Negotiation phase                           Description
       =========================================== ===============================
       ryu.controller.handler.HANDSHAKE_DISPATCHER Sending and waiting for hello
                                                   message
       ryu.controller.handler.CONFIG_DISPATCHER    Version negotiated and sent
                                                   features-request message
       ryu.controller.handler.MAIN_DISPATCHER      Switch-features message
                                                   received and sent set-config
                                                   message
       ryu.controller.handler.DEAD_DISPATCHER      Disconnect from the peer.  Or
                                                   disconnecting due to some
                                                   unrecoverable errors.
       =========================================== ===============================
       """
    @set_ev_cls(ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER)
```

### æ–°å¢ Table-miss Flow Entry

```python
@set_ev_cls(ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER)
    def switch_features_handler(self, ev):
        """
         OpenFlow äº¤æ›å™¨çš„æ¡æ‰‹å”è­°å®Œæˆä¹‹å¾Œï¼Œæ–°å¢ Table-miss Flow Entry
         åˆ° Flow table ä¸­ç‚ºæ¥æ”¶ Packet-In è¨Šæ¯åšæº–å‚™ã€‚
        æ¥æ”¶åˆ° Switch featuresï¼ˆ Features reply ï¼‰è¨Šæ¯å¾Œå°±æœƒæ–°å¢ Table-miss Flow Entryã€‚
        """
        # ev.msg æ˜¯ç”¨ä¾†å„²å­˜å°æ‡‰äº‹ä»¶çš„ OpenFlow è¨Šæ¯é¡åˆ¥å¯¦é«”ã€‚
        # è¿™é‡Œæ˜¯ryu.ofproto.ofproto_v1_3_parser.OFPSwitchFeatures
        # msg.datapath é€™å€‹è¨Šæ¯æ˜¯ç”¨ä¾†å„²å­˜ OpenFlow äº¤æ›å™¨çš„ ryu.controller.controller.Datapath é¡åˆ¥æ‰€å°æ‡‰çš„å¯¦é«”ã€‚
        datapath = ev.msg.datapath
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser
# install table-miss flow entry
        #
        # We specify NO BUFFER to max_len of the output action due to
        # OVS bug. At this moment, if we specify a lesser number, e.g.,
        # 128, OVS will send Packet-In with invalid buffer_id and
        # truncated packet data. In that case, we cannot output packets
        # correctly.  The bug has been fixed in OVS v2.1.0.
        match = parser.OFPMatch()  # ç©ºçš„ match å°‡è¢«ç”¢ç”Ÿç‚ºäº† match æ‰€æœ‰çš„å°åŒ…ã€‚match è¡¨ç¤ºæ–¼ OFPMatch é¡åˆ¥ä¸­ã€‚
        """
        ç‚ºäº†è½‰é€åˆ° Controller é€£æ¥åŸ ï¼Œ OUTPUT action é¡åˆ¥ï¼ˆ OFPActionOutput ï¼‰çš„
        å¯¦ä¾‹å°‡æœƒè¢«ç”¢ç”Ÿã€‚Controller æœƒè¢«æŒ‡å®šç‚ºå°åŒ…çš„ç›®çš„åœ°ï¼ŒOFPCML_NO_BUFFER æœƒè¢«è¨­å®šç‚º max_len ä»¥ä¾¿æ¥ä¸‹ä¾†çš„å°åŒ…å‚³é€ã€‚
        """
        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,
                                          ofproto.OFPCML_NO_BUFFER)]
        """
        Table-miss Flow Entry çš„å„ªå…ˆæ¬Šç‚º 0 å³æœ€ä½çš„å„ªå…ˆæ¬Šï¼Œè€Œä¸”æ­¤ Entry å¯ä»¥ match æ‰€æœ‰çš„å°åŒ…ã€‚
        é€™å€‹ Entry çš„ Instruction é€šå¸¸æŒ‡å®šç‚º output action ï¼Œä¸¦ä¸”è¼¸å‡ºçš„é€£æ¥åŸ å°‡æŒ‡å‘ Controllerã€‚ å› æ­¤ç•¶å°åŒ…æ²’æœ‰ match ä»»ä½•ä¸€å€‹æ™®é€š Flow Entry æ™‚ï¼Œå‰‡è§¸ç™¼ Packet-Inã€‚
        å°‡å„ªå…ˆæ¬Šè¨­å®šç‚º 0ï¼ˆ æœ€ä½å„ªå…ˆæ¬Š ï¼‰ï¼Œç„¶å¾ŒåŸ·è¡Œ add_flow() æ–¹æ³•ä»¥ç™¼é€ Flow Mod è¨Šæ¯
        """
        self.add_flow(datapath, 0, match, actions)
```

### Packet-inå¤„ç†

```python
"""
    class OFPPacketIn(MsgBase):
    ============= =========================================================
    Attribute     Description
    ============= =========================================================
    buffer_id     ID assigned by datapath   æ¥æ”¶å°åŒ…çš„å…§å®¹è‹¥æ˜¯å­˜åœ¨ OpenFlow äº¤æ›å™¨ä¸Šæ™‚æ‰€æŒ‡å®šçš„ID å¦‚æœåœ¨æ²’æœ‰ buffer çš„ç‹€æ³ä¸‹ï¼Œå‰‡è¨­å®š ryu.ofproto.ofproto_v1_3.OFP_NO_BUFFER
    total_len     Full length of frame  æ¥æ”¶å°åŒ…çš„è³‡æ–™é•·åº¦
    reason        Reason packet is being sent.

                  | OFPR_TABLE_MISS
                  | OFPR_APPLY_ACTION
                  | OFPR_INVALID_TTL
                  | OFPR_ACTION_SET
                  | OFPR_GROUP
                  | OFPR_PACKET_OUT
    table_id      ID of the table that was looked up
    cookie        Cookie of the flow entry that was looked up
    match         Instance of ``OFPMatch``  ryu.ofproto.ofproto_v1_3_parser.OFPMatch é¡åˆ¥çš„å¯¦é«”ï¼Œç”¨ä¾†å„²å­˜æ¥æ”¶å°åŒ…çš„ Meta è³‡è¨Šã€‚
    data          Ethernet frame    æ¥æ”¶å°åŒ…æœ¬èº«çš„ binary è³‡æ–™
    ============= =========================================================
    """

    @set_ev_cls(ofp_event.EventOFPPacketIn, MAIN_DISPATCHER)
    def _packet_in_handler(self, ev):
        # If you hit this you might want to increase
        # the "miss_send_length" of your switch
        if ev.msg.msg_len < ev.msg.total_len:
            self.logger.debug("packet truncated: only %s of %s bytes",
                              ev.msg.msg_len, ev.msg.total_len)
        msg = ev.msg
        datapath = msg.datapath
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser
```

### æ›´æ–° MAC ä½å€è¡¨

```python
# å¾ OFPPacketIn é¡åˆ¥çš„ match å¾—åˆ°æ¥æ”¶åŸ ï¼ˆ in_port ï¼‰
        in_port = msg.match['in_port']

        pkt = packet.Packet(msg.data)
        eth = pkt.get_protocols(ethernet.ethernet)[0]

        if eth.ethertype == ether_types.ETH_TYPE_LLDP:
            # ignore lldp packet
            return
        #  ç›®çš„ MAC ä½å€å’Œä¾†æº MAC ä½å€ä½¿ç”¨ Ryu çš„å°åŒ…å‡½å¼åº«ï¼Œå¾æ¥æ”¶åˆ°å°åŒ…çš„ Ethernet header å–å¾—ã€‚
        dst = eth.dst
        src = eth.src

        dpid = format(datapath.id, "d").zfill(16)
        self.mac_to_port.setdefault(dpid, {})

        self.logger.info("packet in %s %s %s %s", dpid, src, dst, in_port)

        # learn a mac address to avoid FLOOD next time.
        self.mac_to_port[dpid][src] = in_port
```

### åˆ¤æ–­å°åŒ…çš„è¿æ¥åœ°å€

```python
"""
        ç›®çš„ MAC ä½å€è‹¥å­˜åœ¨äº MAC ä½å€è¡¨ï¼Œå‰‡åˆ¤æ–·è©²é€£æ¥åŸ çš„è™Ÿç¢¼ç‚ºè¼¸å‡ºã€‚
        åä¹‹è‹¥ä¸å­˜åœ¨äº MAC ä½å€è¡¨å‰‡ OUTPUT action é¡åˆ¥çš„å¯¦é«”ä¸¦ç”Ÿæˆ floodingï¼ˆ OFPP_FLOOD ï¼‰çµ¦ç›®çš„é€£æ¥åŸ ä½¿ç”¨ã€‚
        """
        """
        åœ¨ OpenFlow ä¸­ï¼Œæœ‰å€‹é‚è¼¯é€£æ¥åŸ å«åš NORMAL ä¸¦åœ¨è¦ç¯„ä¸­è¢«åˆ—ç‚ºé¸é …
        ï¼ˆ ä¹Ÿå°±æ˜¯èªªå¯ä»¥ä¸é€²è¡Œå¯¦ä½œ ï¼‰ã€‚ç•¶è¢«æŒ‡å®šçš„é€£æ¥åŸ ç‚º NORMAL æ™‚ï¼Œ
        å‚³çµ± L2/L3 çš„åŠŸèƒ½å°‡æœƒè¢«å•Ÿç”¨ä¾†è™•ç†å°åŒ…ã€‚ æ„æ€æ˜¯ç•¶æŠŠæ‰€æœ‰è¼¸å‡ºçš„åŸ å‡è¨­å®šç‚º NORMAL 
        æ™‚ï¼Œäº¤æ›å™¨å°‡æœƒè¦–ä½œä¸€å€‹æ™®é€šçš„äº¤æ›å™¨è€Œå­˜åœ¨ã€‚è·Ÿä¸€èˆ¬äº¤æ›å™¨çš„å·®åˆ¥åœ¨æ–¼æˆ‘å€‘æ˜¯ä½¿ç”¨ 
        OpenFlow ä¾†é”åˆ°é€™æ¨£çš„åŠŸèƒ½ã€‚
        """
        if dst in self.mac_to_port[dpid]:
            # è‹¥æ˜¯æ‰¾åˆ°äº†ç›®çš„ MAC ä½å€ï¼Œå‰‡åœ¨äº¤æ›å™¨çš„ Flow table ä¸­æ–°å¢
            out_port = self.mac_to_port[dpid][dst]
        else:
            out_port = ofproto.OFPP_FLOOD
        # Table-miss Flow Entry åŒ…å« match å’Œ actionï¼Œä¸¦é€é add_flow() ä¾†æ–°å¢
        actions = [parser.OFPActionOutput(out_port)]
```

### æ–°å¢ Flow Entry çš„å¤„ç†

```python
"""
    å°æ–¼ Flow Entry ä¾†èªªï¼Œè¨­å®š match æ¢ä»¶ä»¥åˆ†è¾¨ç›®æ¨™å°åŒ…ã€è¨­å®š instruction 
    ä»¥è™•ç†å°åŒ…ä»¥åŠ Entry çš„å„ªå…ˆæ¬Šå’Œæœ‰æ•ˆæ™‚é–“ã€‚
    """
    def add_flow(self, datapath, priority, match, actions, buffer_id=None):
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser
        """
        å°æ–¼äº¤æ›å™¨çš„çš„å¯¦ä½œï¼ŒApply Actions æ˜¯ç”¨ä¾†è¨­å®šé‚£äº›å¿…é ˆç«‹å³åŸ·è¡Œçš„ action æ‰€ä½¿ç”¨ã€‚
        æœ€å¾Œé€é Flow Mod è¨Šæ¯å°‡ Flow Entry æ–°å¢åˆ° Flow table ä¸­ã€‚
        """
        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,
                                             actions)]
        if buffer_id:
            """
            Flow Mod è¨Šæ¯çš„é¡åˆ¥ç‚º OFPFlowMod ã€‚ä½¿ç”¨ OFPFlowMod æ‰€ç”¢ç”Ÿçš„å¯¦é«”é€é Datapath.send_msg() 
            æ–¹æ³•ä¾†ç™¼é€è¨Šæ¯çµ¦ OpenFlow äº¤æ›å™¨ã€‚
            OFPFlowMod é¡åˆ¥çš„å»ºæ§‹å­åƒæ•¸ç›¸ç•¶çš„å¤šï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•¸çš„æƒ…æ³ä¸‹éƒ½æœ‰å…¶é è¨­å€¼ï¼ŒåŸå§‹ç¢¼ä¸­æ‹¬è™Ÿå…§çš„éƒ¨åˆ†å³æ˜¯é è¨­å€¼ã€‚
            """
            """
            class OFPFlowMod(MsgBase):
            Modify Flow entry message
            The controller sends this message to modify the flow table.
            ================ ======================================================
            Attribute        Description
            ================ ======================================================
            cookie           Opaque controller-issued identifier    Controller æ‰€è¨­å®šå„²å­˜çš„è³‡æ–™ï¼Œåœ¨ Entry çš„æ›´æ–°æˆ–è€…åˆªé™¤çš„æ™‚æ‰€éœ€è¦ä½¿ç”¨çš„è³‡æ–™éƒ½æœƒæ”¾åœ¨é€™é‚Šï¼Œç•¶åšéæ¿¾å™¨ä½¿ç”¨ï¼Œè€Œä¸”ä¸å¯ä»¥ä½œç‚ºå°åŒ…è™•ç†çš„åƒæ•¸ã€‚
            cookie_mask      Mask used to restrict the cookie bits that must match
                             when the command is ``OPFFC_MODIFY*`` or
                             ``OFPFC_DELETE*``
                             Entry çš„æ›´æ–°æˆ–åˆªé™¤æ™‚ï¼Œè‹¥æ˜¯è©²å€¼ç‚ºéé›¶ï¼Œå‰‡åšç‚ºæŒ‡å®š Entry çš„ cookie ä½¿ç”¨ã€‚
            table_id         ID of the table to put the flow in æŒ‡å®š Flow Entry çš„ Table ID 
            command          One of the following values.
        
                             | OFPFC_ADD    	Flow Entry æ–°å¢
                             | OFPFC_MODIFY     Flow Entry æ›´æ–°
                             | OFPFC_MODIFY_STRICT      åš´æ ¼çš„ Flow Entry æ›´æ–°
                             | OFPFC_DELETE     Flow Entry åˆªé™¤
                             | OFPFC_DELETE_STRICT      åš´æ ¼çš„ Flow Entry åˆªé™¤
            idle_timeout     Idle time before discarding (seconds)  Flow Entry çš„æœ‰æ•ˆæœŸé™ï¼Œä»¥ç§’ç‚ºå–®ä½ã€‚Flow Entry å¦‚æœæœªè¢«åƒç…§è€Œä¸”è¶…éäº†æŒ‡å®šçš„æ™‚é–“ä¹‹å¾Œï¼Œ è©² Flow Entry å°‡æœƒè¢«åˆªé™¤ã€‚å¦‚æœ Flow Entry æœ‰è¢«åƒç…§ï¼Œå‰‡è¶…éæ™‚é–“ä¹‹å¾Œæœƒé‡æ–°æ­¸é›¶è¨ˆç®—ã€‚åœ¨ Flow Entry è¢«åˆªé™¤ä¹‹å¾Œå°±æœƒç™¼å‡º Flow Removed è¨Šæ¯é€šçŸ¥ Controller 
            hard_timeout     Max time before discarding (seconds)   Flow Entry çš„æœ‰æ•ˆæœŸé™ï¼Œä»¥ç§’ç‚ºå–®ä½ã€‚è·Ÿ idle_timeout ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œ hard_timeout åœ¨è¶…éæ™‚é™å¾Œä¸¦ä¸æœƒé‡æ–°æ­¸é›¶è¨ˆç®—ã€‚ ä¹Ÿå°±æ˜¯èªªè·Ÿ Flow Entry èˆ‡æœ‰æ²’æœ‰è¢«åƒç…§ç„¡é—œï¼Œåªè¦è¶…éæŒ‡å®šçš„æ™‚é–“å°±æœƒè¢«åˆªé™¤ã€‚è·Ÿ idle_timeout ä¸€æ¨£ï¼Œç•¶ Flow Entry è¢«åˆªé™¤æ™‚ï¼ŒFlow Removed è¨Šæ¯å°‡æœƒè¢«ç™¼é€ä¾†é€šçŸ¥ Controllerã€‚
            priority         Priority level of flow entry   Flow Entry çš„å„ªå…ˆæ¬Šã€‚æ•¸å€¼è¶Šå¤§è¡¨ç¤ºæ¬Šé™è¶Šé«˜ã€‚
            buffer_id        Buffered packet to apply to (or OFP_NO_BUFFER)     æŒ‡å®š OpenFlow äº¤æ›å™¨ä¸Šç”¨ä¾†å„²å­˜å°åŒ…çš„ç·©è¡å€ IDã€‚ ç·©è¡å€ ID æœƒæ”¾åœ¨é€šçŸ¥ Controller çš„ Packet-In è¨Šæ¯ä¸­ï¼Œä¸¦ä¸”å’Œæ¥ä¸‹ä¾†çš„ OFPP_TABLE æ‰€æŒ‡å®šçš„è¼¸å‡ºåŸ å’Œ Flow Mod è¨Šæ¯è™•ç†æ™‚å¯ä»¥è¢«åƒç…§ã€‚ ç•¶ç™¼é€çš„å‘½ä»¤è¨Šæ¯ç‚º OFPFC_DELETE æˆ– OFPFC_DELETE_STRICT æ™‚ï¼Œæœƒå¿½ç•¥æœ¬æ•¸å€¼ã€‚å¦‚æœä¸æŒ‡å®šç·©è¡å€ ID çš„æ™‚å€™ï¼Œå¿…é ˆä½¿ç”¨ OFP_NO_BUFFER ä½œç‚ºå…¶è¨­å®šå€¼ã€‚
            out_port         For ``OFPFC_DELETE*`` commands, require matching
                             entries to include this as an output port
                             OFPFC_DELETE å’Œ OFPFC_DELETE_STRICT å‘½ä»¤ç”¨ä¾†æŒ‡å®šè¼¸å‡ºåŸ çš„åƒæ•¸ã€‚ å‘½ä»¤ç‚º OFPFC_ADDã€OFPFC_MODIFYã€OFPFC_MODIFY_STRICT æ™‚å‰‡å¯ä»¥å¿½ç•¥ã€‚è‹¥è¦è®“æœ¬åƒæ•¸ç„¡æ•ˆå‰‡æŒ‡å®šè¼¸å‡ºåŸ ç‚º OFPP_ANY ã€‚
            out_group        For ``OFPFC_DELETE*`` commands, require matching
                             entries to include this as an output group
                             è·Ÿ out_port ä¸€æ¨£ï¼Œä½œç‚ºä¸€å€‹è¼¸å‡ºåŸ ï¼Œä½†æ˜¯è½‰åˆ°ç‰¹å®šçš„ groupã€‚è‹¥è¦ä½¿å…¶ç„¡æ•ˆï¼Œå‰‡æŒ‡å®šç‚º OFPG_ANY ã€‚
            flags            Bitmap of the following flags.
        
                             | OFPFF_SEND_FLOW_REM  Flow Entry è¢«ç§»é™¤çš„æ™‚å€™ï¼Œå° Controller ç™¼é€ Removed è¨Šæ¯ã€‚
                             | OFPFF_CHECK_OVERLAP  ä½¿ç”¨ OFPFC_ADD æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„ Flow Entry å­˜åœ¨ã€‚ è‹¥æ˜¯æœ‰å‰‡è§¸ç™¼ Flow Mod å¤±æ•—ï¼Œä¸¦è¿”å›éŒ¯èª¤è¨Šæ¯ã€‚
                             | OFPFF_RESET_COUNTS   é‡è¨­è©² Flow Entry çš„ packet counter å’Œ byte counterã€‚
                             | OFPFF_NO_PKT_COUNTS  é—œé–‰è©² Flow Entry çš„ packet counter åŠŸèƒ½ã€‚
                             | OFPFF_NO_BYT_COUNTS  é—œé–‰è©² Flow Entry çš„ byte counter åŠŸèƒ½ã€‚
            importance       Eviction precedence
            match            Instance of ``OFPMatch``   è¨­å®š match
            instructions     list of ``OFPInstruction*`` instance
            datapath         OpenFlow äº¤æ›å™¨ä»¥åŠ Flow table çš„æ“ä½œéƒ½æ˜¯é€é Datapath é¡åˆ¥çš„å¯¦é«”ä¾†é€²è¡Œã€‚ åœ¨ä¸€èˆ¬çš„æƒ…æ³ä¸‹ï¼Œæœƒç”±äº‹ä»¶å‚³éçµ¦äº‹ä»¶ç®¡ç†çš„è¨Šæ¯ä¸­å–å¾—ï¼Œä¾‹å¦‚ï¼šPacket-In è¨Šæ¯ã€‚
            ================ ======================================================
            """
            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,
                                    priority=priority, match=match,
                                    instructions=inst)
        else:
            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,
                                    match=match, instructions=inst)
        datapath.send_msg(mod)
```

### ä¼ è¾“å°åŒ…

```python
 data = None
        if msg.buffer_id == ofproto.OFP_NO_BUFFER:
            data = msg.data
        """
        Packet-Out message

        The controller uses this message to send a packet out throught the
        switch.
        
         ================ ======================================================
        Attribute        Description
        ================ ======================================================
        buffer_id        ID assigned by datapath (OFP_NO_BUFFER if none)    æŒ‡å®š OpenFlow äº¤æ›å™¨ä¸Šå°åŒ…å°æ‡‰çš„ç·©è¡å€ã€‚ å¦‚æœä¸æƒ³ä½¿ç”¨ç·©è¡å€ï¼Œå‰‡æŒ‡å®šç‚º OFP_NO_BUFFER ã€‚
        match            Instance of ``OFPMatch``
                         (``in_port`` is mandatory in the match field)
        actions          list of OpenFlow action class  æŒ‡å®š actions listã€‚
        data             Packet data of a binary type value or
                         an instances of packet.Packet.
                         è¨­å®šå°åŒ…çš„ binary data ã€‚ä¸»è¦ç”¨åœ¨ buffer_id ç‚º OFP_NO_BUFFER çš„æƒ…æ³ã€‚ å¦‚æœä½¿ç”¨äº† OpenFlow äº¤æ›å™¨çš„ç·©è¡å€å‰‡å¯ä»¥çœç•¥ã€‚
        datapath         æŒ‡å®š OpenFlow äº¤æ›å™¨å°æ‡‰çš„ Datapath é¡åˆ¥å¯¦é«”
        in_port          æŒ‡å®šæ¥æ”¶å°åŒ…çš„é€£æ¥åŸ è™Ÿã€‚ å¦‚æœä¸æƒ³ä½¿ç”¨çš„è©±å°±æŒ‡å®šç‚º OFPP_CONTROLLER ã€‚
        ================ ======================================================
        äº¤æ›å™¨çš„å¯¦ä½œæ™‚ï¼Œåœ¨ Packet-In è¨Šæ¯ä¸­æŒ‡å®š buffer_idã€‚è‹¥æ˜¯ Packet-In è¨Šæ¯ä¸­ buffer_id è¢«è¨­å®šç‚ºç„¡æ•ˆæ™‚ã€‚Packet-In çš„å°åŒ…å¿…é ˆæŒ‡å®š data ä»¥ä¾¿å‚³é€ã€‚
        """
        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,
                                  in_port=in_port, actions=actions, data=data)
        datapath.send_msg(out)
```

### å…¨æ–‡ä»¶

```python
# Copyright (C) 2011 Nippon Telegraph and Telephone Corporation.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied.
# See the License for the specific language governing permissions and
# limitations under the License.

from ryu.base import app_manager
from ryu.controller import ofp_event
from ryu.controller.handler import CONFIG_DISPATCHER, MAIN_DISPATCHER
from ryu.controller.handler import set_ev_cls
from ryu.ofproto import ofproto_v1_3
from ryu.lib.packet import packet
from ryu.lib.packet import ethernet
from ryu.lib.packet import ether_types


class SimpleSwitch13(app_manager.RyuApp):
    OFP_VERSIONS = [ofproto_v1_3.OFP_VERSION]

    def __init__(self, *args, **kwargs):
        super(SimpleSwitch13, self).__init__(*args, **kwargs)
        self.mac_to_port = {}

    """
       æ¥å—åˆ°ä»»ä½•ä¸€å€‹ OpenFlow è¨Šæ¯å³æœƒç”¢ç”Ÿä¸€å€‹ç›¸å°æ‡‰çš„äº‹ä»¶
       äº‹ä»¶ç®¡ç†ï¼ˆ Event Handler ï¼‰ä½¿ç”¨ä¿®é£¾å™¨ï¼ˆ Decorator ï¼‰æ ‡è®°
       set_ev_cls å‰‡æŒ‡å®šäº‹ä»¶é¡åˆ¥å¾—ä»¥æ¥å—è¨Šæ¯å’Œäº¤æ›å™¨ç‹€æ…‹ä½œç‚ºåƒæ•¸ã€‚
       åç¨±çš„è¦å‰‡ç‚º ryu.controller.ofp_event.EventOFP + <OpenFlowè¨Šæ¯åç¨±>

       =========================================== ===============================
       Negotiation phase                           Description
       =========================================== ===============================
       ryu.controller.handler.HANDSHAKE_DISPATCHER Sending and waiting for hello
                                                   message
       ryu.controller.handler.CONFIG_DISPATCHER    Version negotiated and sent
                                                   features-request message
       ryu.controller.handler.MAIN_DISPATCHER      Switch-features message
                                                   received and sent set-config
                                                   message
       ryu.controller.handler.DEAD_DISPATCHER      Disconnect from the peer.  Or
                                                   disconnecting due to some
                                                   unrecoverable errors.
       =========================================== ===============================
       """
    @set_ev_cls(ofp_event.EventOFPSwitchFeatures, CONFIG_DISPATCHER)
    def switch_features_handler(self, ev):
        """
         OpenFlow äº¤æ›å™¨çš„æ¡æ‰‹å”è­°å®Œæˆä¹‹å¾Œï¼Œæ–°å¢ Table-miss Flow Entry
         åˆ° Flow table ä¸­ç‚ºæ¥æ”¶ Packet-In è¨Šæ¯åšæº–å‚™ã€‚
        æ¥æ”¶åˆ° Switch featuresï¼ˆ Features reply ï¼‰è¨Šæ¯å¾Œå°±æœƒæ–°å¢ Table-miss Flow Entryã€‚
        """
        # ev.msg æ˜¯ç”¨ä¾†å„²å­˜å°æ‡‰äº‹ä»¶çš„ OpenFlow è¨Šæ¯é¡åˆ¥å¯¦é«”ã€‚
        # è¿™é‡Œæ˜¯ryu.ofproto.ofproto_v1_3_parser.OFPSwitchFeatures
        # msg.datapath é€™å€‹è¨Šæ¯æ˜¯ç”¨ä¾†å„²å­˜ OpenFlow äº¤æ›å™¨çš„ ryu.controller.controller.Datapath é¡åˆ¥æ‰€å°æ‡‰çš„å¯¦é«”ã€‚
        datapath = ev.msg.datapath
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser

        # install table-miss flow entry
        #
        # We specify NO BUFFER to max_len of the output action due to
        # OVS bug. At this moment, if we specify a lesser number, e.g.,
        # 128, OVS will send Packet-In with invalid buffer_id and
        # truncated packet data. In that case, we cannot output packets
        # correctly.  The bug has been fixed in OVS v2.1.0.
        match = parser.OFPMatch()  # ç©ºçš„ match å°‡è¢«ç”¢ç”Ÿç‚ºäº† match æ‰€æœ‰çš„å°åŒ…ã€‚match è¡¨ç¤ºæ–¼ OFPMatch é¡åˆ¥ä¸­ã€‚
        """
        ç‚ºäº†è½‰é€åˆ° Controller é€£æ¥åŸ ï¼Œ OUTPUT action é¡åˆ¥ï¼ˆ OFPActionOutput ï¼‰çš„
        å¯¦ä¾‹å°‡æœƒè¢«ç”¢ç”Ÿã€‚Controller æœƒè¢«æŒ‡å®šç‚ºå°åŒ…çš„ç›®çš„åœ°ï¼ŒOFPCML_NO_BUFFER æœƒè¢«è¨­å®šç‚º max_len ä»¥ä¾¿æ¥ä¸‹ä¾†çš„å°åŒ…å‚³é€ã€‚
        """
        actions = [parser.OFPActionOutput(ofproto.OFPP_CONTROLLER,
                                          ofproto.OFPCML_NO_BUFFER)]
        """
        Table-miss Flow Entry çš„å„ªå…ˆæ¬Šç‚º 0 å³æœ€ä½çš„å„ªå…ˆæ¬Šï¼Œè€Œä¸”æ­¤ Entry å¯ä»¥ match æ‰€æœ‰çš„å°åŒ…ã€‚
        é€™å€‹ Entry çš„ Instruction é€šå¸¸æŒ‡å®šç‚º output action ï¼Œä¸¦ä¸”è¼¸å‡ºçš„é€£æ¥åŸ å°‡æŒ‡å‘ Controllerã€‚ å› æ­¤ç•¶å°åŒ…æ²’æœ‰ match ä»»ä½•ä¸€å€‹æ™®é€š Flow Entry æ™‚ï¼Œå‰‡è§¸ç™¼ Packet-Inã€‚
        å°‡å„ªå…ˆæ¬Šè¨­å®šç‚º 0ï¼ˆ æœ€ä½å„ªå…ˆæ¬Š ï¼‰ï¼Œç„¶å¾ŒåŸ·è¡Œ add_flow() æ–¹æ³•ä»¥ç™¼é€ Flow Mod è¨Šæ¯
        """
        self.add_flow(datapath, 0, match, actions)

    """
    å°æ–¼ Flow Entry ä¾†èªªï¼Œè¨­å®š match æ¢ä»¶ä»¥åˆ†è¾¨ç›®æ¨™å°åŒ…ã€è¨­å®š instruction 
    ä»¥è™•ç†å°åŒ…ä»¥åŠ Entry çš„å„ªå…ˆæ¬Šå’Œæœ‰æ•ˆæ™‚é–“ã€‚
    """
    def add_flow(self, datapath, priority, match, actions, buffer_id=None):
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser
        """
        å°æ–¼äº¤æ›å™¨çš„çš„å¯¦ä½œï¼ŒApply Actions æ˜¯ç”¨ä¾†è¨­å®šé‚£äº›å¿…é ˆç«‹å³åŸ·è¡Œçš„ action æ‰€ä½¿ç”¨ã€‚
        æœ€å¾Œé€é Flow Mod è¨Šæ¯å°‡ Flow Entry æ–°å¢åˆ° Flow table ä¸­ã€‚
        """
        inst = [parser.OFPInstructionActions(ofproto.OFPIT_APPLY_ACTIONS,
                                             actions)]
        if buffer_id:
            """
            Flow Mod è¨Šæ¯çš„é¡åˆ¥ç‚º OFPFlowMod ã€‚ä½¿ç”¨ OFPFlowMod æ‰€ç”¢ç”Ÿçš„å¯¦é«”é€é Datapath.send_msg() 
            æ–¹æ³•ä¾†ç™¼é€è¨Šæ¯çµ¦ OpenFlow äº¤æ›å™¨ã€‚
            OFPFlowMod é¡åˆ¥çš„å»ºæ§‹å­åƒæ•¸ç›¸ç•¶çš„å¤šï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•¸çš„æƒ…æ³ä¸‹éƒ½æœ‰å…¶é è¨­å€¼ï¼ŒåŸå§‹ç¢¼ä¸­æ‹¬è™Ÿå…§çš„éƒ¨åˆ†å³æ˜¯é è¨­å€¼ã€‚
            """
            """
            class OFPFlowMod(MsgBase):
            Modify Flow entry message
            The controller sends this message to modify the flow table.
            ================ ======================================================
            Attribute        Description
            ================ ======================================================
            cookie           Opaque controller-issued identifier    Controller æ‰€è¨­å®šå„²å­˜çš„è³‡æ–™ï¼Œåœ¨ Entry çš„æ›´æ–°æˆ–è€…åˆªé™¤çš„æ™‚æ‰€éœ€è¦ä½¿ç”¨çš„è³‡æ–™éƒ½æœƒæ”¾åœ¨é€™é‚Šï¼Œç•¶åšéæ¿¾å™¨ä½¿ç”¨ï¼Œè€Œä¸”ä¸å¯ä»¥ä½œç‚ºå°åŒ…è™•ç†çš„åƒæ•¸ã€‚
            cookie_mask      Mask used to restrict the cookie bits that must match
                             when the command is ``OPFFC_MODIFY*`` or
                             ``OFPFC_DELETE*``
                             Entry çš„æ›´æ–°æˆ–åˆªé™¤æ™‚ï¼Œè‹¥æ˜¯è©²å€¼ç‚ºéé›¶ï¼Œå‰‡åšç‚ºæŒ‡å®š Entry çš„ cookie ä½¿ç”¨ã€‚
            table_id         ID of the table to put the flow in æŒ‡å®š Flow Entry çš„ Table ID 
            command          One of the following values.
        
                             | OFPFC_ADD    	Flow Entry æ–°å¢
                             | OFPFC_MODIFY     Flow Entry æ›´æ–°
                             | OFPFC_MODIFY_STRICT      åš´æ ¼çš„ Flow Entry æ›´æ–°
                             | OFPFC_DELETE     Flow Entry åˆªé™¤
                             | OFPFC_DELETE_STRICT      åš´æ ¼çš„ Flow Entry åˆªé™¤
            idle_timeout     Idle time before discarding (seconds)  Flow Entry çš„æœ‰æ•ˆæœŸé™ï¼Œä»¥ç§’ç‚ºå–®ä½ã€‚Flow Entry å¦‚æœæœªè¢«åƒç…§è€Œä¸”è¶…éäº†æŒ‡å®šçš„æ™‚é–“ä¹‹å¾Œï¼Œ è©² Flow Entry å°‡æœƒè¢«åˆªé™¤ã€‚å¦‚æœ Flow Entry æœ‰è¢«åƒç…§ï¼Œå‰‡è¶…éæ™‚é–“ä¹‹å¾Œæœƒé‡æ–°æ­¸é›¶è¨ˆç®—ã€‚åœ¨ Flow Entry è¢«åˆªé™¤ä¹‹å¾Œå°±æœƒç™¼å‡º Flow Removed è¨Šæ¯é€šçŸ¥ Controller 
            hard_timeout     Max time before discarding (seconds)   Flow Entry çš„æœ‰æ•ˆæœŸé™ï¼Œä»¥ç§’ç‚ºå–®ä½ã€‚è·Ÿ idle_timeout ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œ hard_timeout åœ¨è¶…éæ™‚é™å¾Œä¸¦ä¸æœƒé‡æ–°æ­¸é›¶è¨ˆç®—ã€‚ ä¹Ÿå°±æ˜¯èªªè·Ÿ Flow Entry èˆ‡æœ‰æ²’æœ‰è¢«åƒç…§ç„¡é—œï¼Œåªè¦è¶…éæŒ‡å®šçš„æ™‚é–“å°±æœƒè¢«åˆªé™¤ã€‚è·Ÿ idle_timeout ä¸€æ¨£ï¼Œç•¶ Flow Entry è¢«åˆªé™¤æ™‚ï¼ŒFlow Removed è¨Šæ¯å°‡æœƒè¢«ç™¼é€ä¾†é€šçŸ¥ Controllerã€‚
            priority         Priority level of flow entry   Flow Entry çš„å„ªå…ˆæ¬Šã€‚æ•¸å€¼è¶Šå¤§è¡¨ç¤ºæ¬Šé™è¶Šé«˜ã€‚
            buffer_id        Buffered packet to apply to (or OFP_NO_BUFFER)     æŒ‡å®š OpenFlow äº¤æ›å™¨ä¸Šç”¨ä¾†å„²å­˜å°åŒ…çš„ç·©è¡å€ IDã€‚ ç·©è¡å€ ID æœƒæ”¾åœ¨é€šçŸ¥ Controller çš„ Packet-In è¨Šæ¯ä¸­ï¼Œä¸¦ä¸”å’Œæ¥ä¸‹ä¾†çš„ OFPP_TABLE æ‰€æŒ‡å®šçš„è¼¸å‡ºåŸ å’Œ Flow Mod è¨Šæ¯è™•ç†æ™‚å¯ä»¥è¢«åƒç…§ã€‚ ç•¶ç™¼é€çš„å‘½ä»¤è¨Šæ¯ç‚º OFPFC_DELETE æˆ– OFPFC_DELETE_STRICT æ™‚ï¼Œæœƒå¿½ç•¥æœ¬æ•¸å€¼ã€‚å¦‚æœä¸æŒ‡å®šç·©è¡å€ ID çš„æ™‚å€™ï¼Œå¿…é ˆä½¿ç”¨ OFP_NO_BUFFER ä½œç‚ºå…¶è¨­å®šå€¼ã€‚
            out_port         For ``OFPFC_DELETE*`` commands, require matching
                             entries to include this as an output port
                             OFPFC_DELETE å’Œ OFPFC_DELETE_STRICT å‘½ä»¤ç”¨ä¾†æŒ‡å®šè¼¸å‡ºåŸ çš„åƒæ•¸ã€‚ å‘½ä»¤ç‚º OFPFC_ADDã€OFPFC_MODIFYã€OFPFC_MODIFY_STRICT æ™‚å‰‡å¯ä»¥å¿½ç•¥ã€‚è‹¥è¦è®“æœ¬åƒæ•¸ç„¡æ•ˆå‰‡æŒ‡å®šè¼¸å‡ºåŸ ç‚º OFPP_ANY ã€‚
            out_group        For ``OFPFC_DELETE*`` commands, require matching
                             entries to include this as an output group
                             è·Ÿ out_port ä¸€æ¨£ï¼Œä½œç‚ºä¸€å€‹è¼¸å‡ºåŸ ï¼Œä½†æ˜¯è½‰åˆ°ç‰¹å®šçš„ groupã€‚è‹¥è¦ä½¿å…¶ç„¡æ•ˆï¼Œå‰‡æŒ‡å®šç‚º OFPG_ANY ã€‚
            flags            Bitmap of the following flags.
        
                             | OFPFF_SEND_FLOW_REM  Flow Entry è¢«ç§»é™¤çš„æ™‚å€™ï¼Œå° Controller ç™¼é€ Removed è¨Šæ¯ã€‚
                             | OFPFF_CHECK_OVERLAP  ä½¿ç”¨ OFPFC_ADD æ™‚ï¼Œæª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„ Flow Entry å­˜åœ¨ã€‚ è‹¥æ˜¯æœ‰å‰‡è§¸ç™¼ Flow Mod å¤±æ•—ï¼Œä¸¦è¿”å›éŒ¯èª¤è¨Šæ¯ã€‚
                             | OFPFF_RESET_COUNTS   é‡è¨­è©² Flow Entry çš„ packet counter å’Œ byte counterã€‚
                             | OFPFF_NO_PKT_COUNTS  é—œé–‰è©² Flow Entry çš„ packet counter åŠŸèƒ½ã€‚
                             | OFPFF_NO_BYT_COUNTS  é—œé–‰è©² Flow Entry çš„ byte counter åŠŸèƒ½ã€‚
            importance       Eviction precedence
            match            Instance of ``OFPMatch``   è¨­å®š match
            instructions     list of ``OFPInstruction*`` instance
            datapath         OpenFlow äº¤æ›å™¨ä»¥åŠ Flow table çš„æ“ä½œéƒ½æ˜¯é€é Datapath é¡åˆ¥çš„å¯¦é«”ä¾†é€²è¡Œã€‚ åœ¨ä¸€èˆ¬çš„æƒ…æ³ä¸‹ï¼Œæœƒç”±äº‹ä»¶å‚³éçµ¦äº‹ä»¶ç®¡ç†çš„è¨Šæ¯ä¸­å–å¾—ï¼Œä¾‹å¦‚ï¼šPacket-In è¨Šæ¯ã€‚
            ================ ======================================================
            """
            mod = parser.OFPFlowMod(datapath=datapath, buffer_id=buffer_id,
                                    priority=priority, match=match,
                                    instructions=inst)
        else:
            mod = parser.OFPFlowMod(datapath=datapath, priority=priority,
                                    match=match, instructions=inst)
        datapath.send_msg(mod)

    """
    class OFPPacketIn(MsgBase):
    ============= =========================================================
    Attribute     Description
    ============= =========================================================
    buffer_id     ID assigned by datapath   æ¥æ”¶å°åŒ…çš„å…§å®¹è‹¥æ˜¯å­˜åœ¨ OpenFlow äº¤æ›å™¨ä¸Šæ™‚æ‰€æŒ‡å®šçš„ID å¦‚æœåœ¨æ²’æœ‰ buffer çš„ç‹€æ³ä¸‹ï¼Œå‰‡è¨­å®š ryu.ofproto.ofproto_v1_3.OFP_NO_BUFFER
    total_len     Full length of frame  æ¥æ”¶å°åŒ…çš„è³‡æ–™é•·åº¦
    reason        Reason packet is being sent.

                  | OFPR_TABLE_MISS
                  | OFPR_APPLY_ACTION
                  | OFPR_INVALID_TTL
                  | OFPR_ACTION_SET
                  | OFPR_GROUP
                  | OFPR_PACKET_OUT
    table_id      ID of the table that was looked up
    cookie        Cookie of the flow entry that was looked up
    match         Instance of ``OFPMatch``  ryu.ofproto.ofproto_v1_3_parser.OFPMatch é¡åˆ¥çš„å¯¦é«”ï¼Œç”¨ä¾†å„²å­˜æ¥æ”¶å°åŒ…çš„ Meta è³‡è¨Šã€‚
    data          Ethernet frame    æ¥æ”¶å°åŒ…æœ¬èº«çš„ binary è³‡æ–™
    ============= =========================================================
    """

    @set_ev_cls(ofp_event.EventOFPPacketIn, MAIN_DISPATCHER)
    def _packet_in_handler(self, ev):
        # If you hit this you might want to increase
        # the "miss_send_length" of your switch
        if ev.msg.msg_len < ev.msg.total_len:
            self.logger.debug("packet truncated: only %s of %s bytes",
                              ev.msg.msg_len, ev.msg.total_len)
        msg = ev.msg
        datapath = msg.datapath
        ofproto = datapath.ofproto
        parser = datapath.ofproto_parser
        # å¾ OFPPacketIn é¡åˆ¥çš„ match å¾—åˆ°æ¥æ”¶åŸ ï¼ˆ in_port ï¼‰
        in_port = msg.match['in_port']

        pkt = packet.Packet(msg.data)
        eth = pkt.get_protocols(ethernet.ethernet)[0]

        if eth.ethertype == ether_types.ETH_TYPE_LLDP:
            # ignore lldp packet
            return
        #  ç›®çš„ MAC ä½å€å’Œä¾†æº MAC ä½å€ä½¿ç”¨ Ryu çš„å°åŒ…å‡½å¼åº«ï¼Œå¾æ¥æ”¶åˆ°å°åŒ…çš„ Ethernet header å–å¾—ã€‚
        dst = eth.dst
        src = eth.src

        dpid = format(datapath.id, "d").zfill(16)
        self.mac_to_port.setdefault(dpid, {})

        self.logger.info("packet in %s %s %s %s", dpid, src, dst, in_port)

        # learn a mac address to avoid FLOOD next time.
        self.mac_to_port[dpid][src] = in_port
        """
        ç›®çš„ MAC ä½å€è‹¥å­˜åœ¨äº MAC ä½å€è¡¨ï¼Œå‰‡åˆ¤æ–·è©²é€£æ¥åŸ çš„è™Ÿç¢¼ç‚ºè¼¸å‡ºã€‚
        åä¹‹è‹¥ä¸å­˜åœ¨äº MAC ä½å€è¡¨å‰‡ OUTPUT action é¡åˆ¥çš„å¯¦é«”ä¸¦ç”Ÿæˆ floodingï¼ˆ OFPP_FLOOD ï¼‰çµ¦ç›®çš„é€£æ¥åŸ ä½¿ç”¨ã€‚
        """
        """
        åœ¨ OpenFlow ä¸­ï¼Œæœ‰å€‹é‚è¼¯é€£æ¥åŸ å«åš NORMAL ä¸¦åœ¨è¦ç¯„ä¸­è¢«åˆ—ç‚ºé¸é …
        ï¼ˆ ä¹Ÿå°±æ˜¯èªªå¯ä»¥ä¸é€²è¡Œå¯¦ä½œ ï¼‰ã€‚ç•¶è¢«æŒ‡å®šçš„é€£æ¥åŸ ç‚º NORMAL æ™‚ï¼Œ
        å‚³çµ± L2/L3 çš„åŠŸèƒ½å°‡æœƒè¢«å•Ÿç”¨ä¾†è™•ç†å°åŒ…ã€‚ æ„æ€æ˜¯ç•¶æŠŠæ‰€æœ‰è¼¸å‡ºçš„åŸ å‡è¨­å®šç‚º NORMAL 
        æ™‚ï¼Œäº¤æ›å™¨å°‡æœƒè¦–ä½œä¸€å€‹æ™®é€šçš„äº¤æ›å™¨è€Œå­˜åœ¨ã€‚è·Ÿä¸€èˆ¬äº¤æ›å™¨çš„å·®åˆ¥åœ¨æ–¼æˆ‘å€‘æ˜¯ä½¿ç”¨ 
        OpenFlow ä¾†é”åˆ°é€™æ¨£çš„åŠŸèƒ½ã€‚
        """
        if dst in self.mac_to_port[dpid]:
            # è‹¥æ˜¯æ‰¾åˆ°äº†ç›®çš„ MAC ä½å€ï¼Œå‰‡åœ¨äº¤æ›å™¨çš„ Flow table ä¸­æ–°å¢
            out_port = self.mac_to_port[dpid][dst]
        else:
            out_port = ofproto.OFPP_FLOOD
        # Table-miss Flow Entry åŒ…å« match å’Œ actionï¼Œä¸¦é€é add_flow() ä¾†æ–°å¢
        actions = [parser.OFPActionOutput(out_port)]

        # install a flow to avoid packet_in next time
        if out_port != ofproto.OFPP_FLOOD:
            # ä¸åŒæ–¼å¹³å¸¸çš„ Table-miss Flow Entry ï¼Œé€™æ¬¡å°‡åŠ ä¸Šè¨­å®š match æ¢ä»¶ã€‚
            # æœ¬æ¬¡äº¤æ›å™¨å¯¦ä½œä¸­ï¼Œæ¥æ”¶åŸ ï¼ˆ in_port ï¼‰å’Œç›®çš„ MAC ä½å€ï¼ˆ eth_dst ï¼‰å·²æŒ‡å®šã€‚ä¾‹å¦‚ï¼Œæ¥æ”¶åˆ°ä¾†è‡ªé€£æ¥åŸ  1 çš„å°åŒ…å°±å‚³é€åˆ° host Bã€‚
            match = parser.OFPMatch(in_port=in_port, eth_dst=dst, eth_src=src)
            # verify if we have a valid buffer_id, if yes avoid to send both
            # flow_mod & packet_out
            if msg.buffer_id != ofproto.OFP_NO_BUFFER:
                # åœ¨é€™é‚ŠæŒ‡å®š Flow Entry å„ªå…ˆæ¬Šç‚º 1ï¼Œè€Œå„ªå…ˆæ¬Šçš„å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºæœ‰æ›´é«˜çš„å„ªå…ˆæ¬Šã€‚
                # å› æ­¤ï¼Œé€™é‚Šæ–°å¢çš„ Flow Entry å°‡æœƒå…ˆæ–¼ Table-miss Flow Entry è€Œè¢«åŸ·è¡Œã€‚
                self.add_flow(datapath, 1, match, actions, msg.buffer_id)
                return
            else:
                self.add_flow(datapath, 1, match, actions)
            # ç»¼ä¸Šï¼Œé€£æ¥åŸ  1 æ¥æ”¶åˆ°çš„å°åŒ…ï¼Œè‹¥æ˜¯è¦è½‰é€è‡³ host Bï¼ˆ ç›®çš„ MAC ä½å€ B) çš„å°åŒ…å‰‡è½‰é€è‡³é€£æ¥åŸ  4ã€‚

        data = None
        if msg.buffer_id == ofproto.OFP_NO_BUFFER:
            data = msg.data
        """
        Packet-Out message

        The controller uses this message to send a packet out throught the
        switch.
        
         ================ ======================================================
        Attribute        Description
        ================ ======================================================
        buffer_id        ID assigned by datapath (OFP_NO_BUFFER if none)    æŒ‡å®š OpenFlow äº¤æ›å™¨ä¸Šå°åŒ…å°æ‡‰çš„ç·©è¡å€ã€‚ å¦‚æœä¸æƒ³ä½¿ç”¨ç·©è¡å€ï¼Œå‰‡æŒ‡å®šç‚º OFP_NO_BUFFER ã€‚
        match            Instance of ``OFPMatch``
                         (``in_port`` is mandatory in the match field)
        actions          list of OpenFlow action class  æŒ‡å®š actions listã€‚
        data             Packet data of a binary type value or
                         an instances of packet.Packet.
                         è¨­å®šå°åŒ…çš„ binary data ã€‚ä¸»è¦ç”¨åœ¨ buffer_id ç‚º OFP_NO_BUFFER çš„æƒ…æ³ã€‚ å¦‚æœä½¿ç”¨äº† OpenFlow äº¤æ›å™¨çš„ç·©è¡å€å‰‡å¯ä»¥çœç•¥ã€‚
        datapath         æŒ‡å®š OpenFlow äº¤æ›å™¨å°æ‡‰çš„ Datapath é¡åˆ¥å¯¦é«”
        in_port          æŒ‡å®šæ¥æ”¶å°åŒ…çš„é€£æ¥åŸ è™Ÿã€‚ å¦‚æœä¸æƒ³ä½¿ç”¨çš„è©±å°±æŒ‡å®šç‚º OFPP_CONTROLLER ã€‚
        ================ ======================================================
        äº¤æ›å™¨çš„å¯¦ä½œæ™‚ï¼Œåœ¨ Packet-In è¨Šæ¯ä¸­æŒ‡å®š buffer_idã€‚è‹¥æ˜¯ Packet-In è¨Šæ¯ä¸­ buffer_id è¢«è¨­å®šç‚ºç„¡æ•ˆæ™‚ã€‚Packet-In çš„å°åŒ…å¿…é ˆæŒ‡å®š data ä»¥ä¾¿å‚³é€ã€‚
        """
        out = parser.OFPPacketOut(datapath=datapath, buffer_id=msg.buffer_id,
                                  in_port=in_port, actions=actions, data=data)
        datapath.send_msg(out)
```

## éƒ¨ç½²å®æ–½

| åç¨±         | æ•¸å€¼       | èªªæ˜                        |
| ---------- | -------- | ------------------------- |
| topo       | single,3 | äº¤æ›å™¨ 1 å°ã€host 3 å°çš„æ‹“ç’       |
| mac        | ç„¡        | è‡ªå‹•è¨­å®š host çš„ MAC ä½å€        |
| switch     | ovsk     | ä½¿ç”¨ Open vSwitch           |
| controller | remote   | æŒ‡å®šå¤–éƒ¨çš„ OpenFlow Controller |
| x          | ç„¡        | å•Ÿå‹• xterm                  |

å‘½ä»¤ï¼š`$ sudo mn --topo single,3 --mac --switch ovsk --controller remote -x`

æŸ¥çœ‹ Open vSwitch çš„ç‹€æ…‹ï¼š`root@ryu-vm:~# ovs-vsctl show`

è¨­å®š OpenFlow çš„ç‰ˆæœ¬ç‚º 1.3ï¼š`root@ryu-vm:~# ovs-vsctl set Bridge s1 protocols=OpenFlow13`

æª¢æŸ¥ç©ºç™½çš„ Flow tableï¼š`root@ryu-vm:~# ovs-ofctl -O OpenFlow13 dump-flows s1`

åœ¨controller c0ä¸­çš„xtermæ‰§è¡Œï¼š`root@ryu-vm:~# ryu-manager --verbose ryu.app.simple_switch_13`

ç¢ºèª Table-miss Flow Entry å·²ç¶“è¢«åŠ å…¥:`root@ryu-vm:~# ovs-ofctl -O openflow13 dump-flows s1`

å„ªå…ˆæ¬Šç‚º 0ï¼Œæ²’æœ‰ matcthï¼Œaction ç‚º CONTROLLERï¼Œé‡é€çš„è³‡æ–™å¤§å°ç‚º 65535 (0xffff = OFPCML\_NO\_BUFFER ï¼‰

## éªŒè¯æ–¹æ¡ˆ

å¾ host 1 å‘ host 2 ç™¼é€ pingã€‚

1.  ARP request

    > æ­¤æ™‚ host 1 ä¸¦ä¸çŸ¥é“ host 2 çš„ MAC ä½å€ï¼ŒåŸå‰‡ä¸Š ICMP echo request ä¹‹å‰çš„ ARP request æ˜¯ç”¨ å»£æ’­çš„æ–¹å¼ç™¼é€ã€‚é€™æ¨£çš„å»£æ’­æ–¹å¼æœƒè®“ host 2 å’Œ host 3 éƒ½åŒæ¨£æ¥å—åˆ°è¨Šæ¯ã€‚
2.  ARP reply

    > host 2 ä½¿ç”¨ ARP reply å›è¦† host 1 è¦æ±‚ã€‚
3.  ICMP echo request

    > ç¾åœ¨ host 1 çŸ¥é“äº† host 2 çš„ MAC ä½å€ï¼Œå› æ­¤ç™¼é€ echo request çµ¦ host 2ã€‚
4.  ICMP echo reply

    > host 2 æ­¤æ™‚ä¹ŸçŸ¥é“äº† host 1 çš„ MAC ä½å€ï¼Œå› æ­¤ç™¼é€ echo reply çµ¦ host 1ã€‚

å…·ä½“å†…å®¹åœ¨[äº¤æ›å™¨ï¼ˆ Switching Hub ï¼‰ â€” Ryubook 1.0 èªªæ˜æ–‡ä»¶ (ryu-sdn.org)](https://book.ryu-sdn.org/zh\_tw/html/switching\_hub.html#id7)æŸ¥çœ‹

